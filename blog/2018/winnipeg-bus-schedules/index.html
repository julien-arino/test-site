<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="zrOU6pP7sLlXf7f0kW-NZRV1lZtdpybCfrJ3BeBMHQM"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Buses or ants? | Julien Arino</title> <meta name="author" content="Julien Arino"> <meta name="description" content="R code for plotting the activity of bus stops during a typical day in Winnipeg, using data downloaded from Winnipeg Transit. Shows how to make movies from the results using convert (ImageMagick) and animation (R library)."> <meta name="keywords" content="mathematical-epidemiology, mathematical-biology"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://julien-arino.github.io/blog/2018/winnipeg-bus-schedules/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> <meta name="generator" content="Jekyll v4.4.1"> <meta property="og:title" content="Buses or ants?"> <meta property="og:locale" content="en"> <meta name="description" content="R code for plotting the activity of bus stops during a typical day in Winnipeg, using data downloaded from Winnipeg Transit. Shows how to make movies from the results using convert (ImageMagick) and animation (R library)."> <meta property="og:description" content="R code for plotting the activity of bus stops during a typical day in Winnipeg, using data downloaded from Winnipeg Transit. Shows how to make movies from the results using convert (ImageMagick) and animation (R library)."> <link rel="canonical" href="https://julien-arino.github.io/blog/2018/winnipeg-bus-schedules/"> <meta property="og:url" content="https://julien-arino.github.io/blog/2018/winnipeg-bus-schedules/"> <meta property="og:site_name" content="blank"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2018-12-16T06:39:22+00:00"> <meta name="twitter:card" content="summary"> <meta property="twitter:title" content="Buses or ants?"> <meta name="google-site-verification" content="zrOU6pP7sLlXf7f0kW-NZRV1lZtdpybCfrJ3BeBMHQM"> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2018-12-16T06:39:22+00:00","datePublished":"2018-12-16T06:39:22+00:00","description":"R code for plotting the activity of bus stops during a typical day in Winnipeg, using data downloaded from Winnipeg Transit. Shows how to make movies from the results using convert (ImageMagick) and animation (R library).","headline":"Buses or ants?","mainEntityOfPage":{"@type":"WebPage","@id":"https://julien-arino.github.io/blog/2018/winnipeg-bus-schedules/"},"url":"https://julien-arino.github.io/blog/2018/winnipeg-bus-schedules/"}</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Julien </span>Arino</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/students/">students</a> </li> <li class="nav-item "> <a class="nav-link" href="/talks/">talks</a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Buses or ants?</h1> <p class="post-meta">December 16, 2018</p> <p class="post-tags"> <a href="/blog/2018"> <i class="fas fa-calendar fa-sm"></i> 2018 </a>   ·   <a href="/blog/category/r-code"> <i class="fas fa-tag fa-sm"></i> r-code</a>   <a href="/blog/category/data"> <i class="fas fa-tag fa-sm"></i> data</a>   <a href="/blog/category/winnipeg"> <i class="fas fa-tag fa-sm"></i> winnipeg</a>   <a href="/blog/category/mapping"> <i class="fas fa-tag fa-sm"></i> mapping</a>   </p> </header> <article class="post-content"> <p>The most recent version of the code used in this page (which might be a little different from the one here) can be found <a href="https://raw.githubusercontent.com/julien-arino/R-code/master/plotWpgStopSchedules_v1.R" rel="external nofollow noopener" target="_blank">here</a>.</p> <p>The city of Winnipeg has some interesting data available online as part of its open data initiative. The main entry point into that data is this <a href="https://data.winnipeg.ca/" title="Winnipeg Open Data portal" rel="external nofollow noopener" target="_blank">page</a>.</p> <p>One city service that contributes to this system is <a href="https://winnipegtransit.com/en" rel="external nofollow noopener" target="_blank">Winnipeg Transit</a>. They have several types of data. In a later entry, I will discuss the use of online queries; here, I use some static data that is available <a href="http://gtfs.winnipegtransit.com/google_transit.zip" rel="external nofollow noopener" target="_blank">here</a>. A description of the different files in the archive can be found <a href="https://developers.google.com/transit/gtfs/reference/?csw=1" rel="external nofollow noopener" target="_blank">here</a>.</p> <p>As a regular bus user, public transit afficionado and someone interested in population movement, I was curious to use this data to study some ideas about population movement. The first step was to do a simple, somewhat fun representation of the information.</p> <p>We will use three libraries: <code class="language-plaintext highlighter-rouge">lubridate</code>, which helps with date manipulation, <code class="language-plaintext highlighter-rouge">OpenStreetMap</code> for getting maps and converting coordinates and <code class="language-plaintext highlighter-rouge">animation</code>, as a way to create a movie. So make sure these are installed. You will also need the program <code class="language-plaintext highlighter-rouge">convert</code>, part of the ImageMagick suite. Installing the latter under Linux is easy; for Windows users, the situation is a bit more tricky, although you may want to consider the Linux subsystem. More on that later.</p> <p>To keep things easy, let us change the directory to the one where the code lies and below which both the data and the figures directories will be located. I am assuming that you downloaded the file from the link above and unzipped it in a subdirectory called <code class="language-plaintext highlighter-rouge">staticSchedule</code>. If generating a gif image, you will also need to create a subdirectory called <code class="language-plaintext highlighter-rouge">tmpFig</code>.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">setwd</span><span class="p">(</span><span class="s2">"~/Documents/DATA/WinnipegTransit"</span><span class="p">)</span></code></pre></figure> <p>We set the day of the query (updated recently). Because we want one “day” worth of transport, from start of movement around 5:00 to end of movement around 2:00 next day, it will be useful to have the next day as well.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">YYYY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2019</span><span class="w">
</span><span class="n">MM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">07</span><span class="w">
</span><span class="n">DD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">04</span><span class="w">
</span><span class="n">Q_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lubridate</span><span class="o">::</span><span class="n">ymd</span><span class="p">(</span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"%s-%s-%s"</span><span class="p">,</span><span class="n">YYYY</span><span class="p">,</span><span class="n">MM</span><span class="p">,</span><span class="n">DD</span><span class="p">))</span><span class="w">
</span><span class="n">Q_date_p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lubridate</span><span class="o">::</span><span class="n">ymd</span><span class="p">(</span><span class="n">Q_date</span><span class="p">)</span><span class="m">+1</span></code></pre></figure> <p>We now load and process <code class="language-plaintext highlighter-rouge">calendar.txt</code>, one of the components of the static schedule. This is a short file, giving the code of the type of operation (weekday, Saturday, Sunday), which is then used in the main stop schedule to single out the stop schedule for that type of operation. Note that when determining day of the week, <code class="language-plaintext highlighter-rouge">lubridate</code> starts with 1 on Sundays.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">calendar</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"staticSchedule/calendar.txt"</span><span class="p">,</span><span class="w">
                     </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span><span class="n">calendar</span><span class="o">$</span><span class="n">start_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lubridate</span><span class="o">::</span><span class="n">ymd</span><span class="p">(</span><span class="n">calendar</span><span class="o">$</span><span class="n">start_date</span><span class="p">)</span><span class="w">
</span><span class="n">calendar</span><span class="o">$</span><span class="n">end_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lubridate</span><span class="o">::</span><span class="n">ymd</span><span class="p">(</span><span class="n">calendar</span><span class="o">$</span><span class="n">end_date</span><span class="p">)</span><span class="w">
</span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intersect</span><span class="p">(</span><span class="n">which</span><span class="p">(</span><span class="n">calendar</span><span class="o">$</span><span class="n">start_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Q_date</span><span class="p">),</span><span class="w">
                </span><span class="n">which</span><span class="p">(</span><span class="n">calendar</span><span class="o">$</span><span class="n">end_date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Q_date_p1</span><span class="p">))</span><span class="w">
</span><span class="n">calendar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calendar</span><span class="p">[</span><span class="n">idx</span><span class="p">,]</span><span class="w">
</span><span class="n">day_week</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lubridate</span><span class="o">::</span><span class="n">wday</span><span class="p">(</span><span class="n">Q_date</span><span class="p">)</span><span class="w">
</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">day_week</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">6</span><span class="p">))</span><span class="w">
  </span><span class="c1"># Weekday service</span><span class="w">
  </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">calendar</span><span class="o">$</span><span class="n">monday</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">day_week</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">7</span><span class="p">)</span><span class="w">
  </span><span class="c1"># Saturday service</span><span class="w">
  </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">calendar</span><span class="o">$</span><span class="n">saturday</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">day_week</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
  </span><span class="c1"># Sunday service</span><span class="w">
  </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">calendar</span><span class="o">$</span><span class="n">sunday</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="n">calendar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calendar</span><span class="p">[</span><span class="n">idx</span><span class="p">,]</span></code></pre></figure> <p>At this point, <code class="language-plaintext highlighter-rouge">calendar</code> should be reduced to a single line. We now load the remaining files that are needed for the plot. (Note that during Fall and Winter terms for universities, not all weekdays are the same, so the tests above should actually differentiate between Monday, Wednesday, Friday on the one hand and Tuesday, Thursday on the other. This was written when school was not in session..)</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">stop_times</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"staticSchedule/stop_times.txt"</span><span class="p">,</span><span class="w">
                       </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span><span class="n">stops</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"staticSchedule/stops.txt"</span><span class="p">,</span><span class="w">
                  </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span><span class="n">trips</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"staticSchedule/trips.txt"</span><span class="p">,</span><span class="w">
                  </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span></code></pre></figure> <p>The files are loaded, we use merge (i.e., JOIN in the SQL world) to make a data frame containing all the required information. Note that this step is not necessary, it just makes plotting much easier.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">monster_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stop_times</span><span class="p">,</span><span class="w">
                      </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stops</span><span class="p">,</span><span class="w">
                      </span><span class="n">by.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"stop_id"</span><span class="p">,</span><span class="w">
                      </span><span class="n">by.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"stop_id"</span><span class="p">)</span><span class="w">
</span><span class="n">monster_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">monster_frame</span><span class="p">,</span><span class="w">
                      </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trips</span><span class="p">,</span><span class="w">
                      </span><span class="n">by.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"trip_id"</span><span class="p">,</span><span class="w">
                      </span><span class="n">by.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"trip_id"</span><span class="p">)</span></code></pre></figure> <p>Now we have a data frame with many columns. We select the rows (over 300,000 of them) corresponding to the chosen type of service selected in <code class="language-plaintext highlighter-rouge">calendar</code>. We then order the entries and make explicit the hour and minutes.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">service_id</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">calendar</span><span class="o">$</span><span class="n">service_id</span><span class="p">)</span><span class="w">
</span><span class="n">monster_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">monster_frame</span><span class="p">[</span><span class="n">idx</span><span class="p">,]</span><span class="w">
</span><span class="n">monster_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">monster_frame</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">arrival_time</span><span class="p">),]</span><span class="w">
</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">HH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">arrival_time</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">))</span><span class="w">
</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">MM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">arrival_time</span><span class="p">,</span><span class="m">4</span><span class="p">,</span><span class="m">5</span><span class="p">))</span><span class="w">
</span><span class="n">monster_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">monster_frame</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="s2">"arrival_time"</span><span class="p">,</span><span class="s2">"HH"</span><span class="p">,</span><span class="s2">"MM"</span><span class="p">,</span><span class="w">
                                 </span><span class="s2">"stop_lat"</span><span class="p">,</span><span class="w">
                                 </span><span class="s2">"stop_lon"</span><span class="p">)]</span></code></pre></figure> <p>Finally, we add latitude and longitude in Mercator format, which is used for plotting.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">monster_frame</span><span class="o">$</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenStreetMap</span><span class="o">::</span><span class="n">projectMercator</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">stop_lat</span><span class="p">,</span><span class="w">
                                                 </span><span class="n">monster_frame</span><span class="o">$</span><span class="n">stop_lon</span><span class="p">)[,</span><span class="m">1</span><span class="p">]</span><span class="w">
</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenStreetMap</span><span class="o">::</span><span class="n">projectMercator</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">stop_lat</span><span class="p">,</span><span class="w">
                                                 </span><span class="n">monster_frame</span><span class="o">$</span><span class="n">stop_lon</span><span class="p">)[,</span><span class="m">2</span><span class="p">]</span></code></pre></figure> <p>Note that since the list is sorted by time, this allows for much faster processing during plotting. Now prepare the plots: download the map from OpenStreetMap.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">Winnipeg_upperLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">stop_lat</span><span class="p">),</span><span class="w">
                       </span><span class="nf">min</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">stop_lon</span><span class="p">))</span><span class="w">
</span><span class="n">Winnipeg_lowerRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">stop_lat</span><span class="p">),</span><span class="w">
                        </span><span class="nf">max</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">stop_lon</span><span class="p">))</span><span class="w">
</span><span class="n">Winnipeg_map</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">OpenStreetMap</span><span class="o">::</span><span class="n">openmap</span><span class="p">(</span><span class="n">upperLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Winnipeg_upperLeft</span><span class="p">,</span><span class="w">
                                       </span><span class="n">lowerRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Winnipeg_lowerRight</span><span class="p">,</span><span class="w">
                                       </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"osm-public-transport"</span><span class="p">)</span></code></pre></figure> <h2 id="first-animation-method---using-convert">First animation method - using convert</h2> <p>Finally, the plot itself. We plot minute by minute, generating one image for each.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">curr_MM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">arrival_time</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">MM</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">curr_MM</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">&gt;</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">dev.off</span><span class="p">()</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">HH</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">23</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">date_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"%s %02d:%02d"</span><span class="p">,</span><span class="w">
                          </span><span class="n">Q_date</span><span class="p">,</span><span class="w">
                          </span><span class="n">monster_frame</span><span class="o">$</span><span class="n">HH</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w">
                          </span><span class="n">monster_frame</span><span class="o">$</span><span class="n">MM</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
      </span><span class="n">plotName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"tmpFig/%s_%02d:%02d.png"</span><span class="p">,</span><span class="w">
                         </span><span class="n">Q_date</span><span class="p">,</span><span class="w">
                         </span><span class="n">monster_frame</span><span class="o">$</span><span class="n">HH</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w">
                         </span><span class="n">monster_frame</span><span class="o">$</span><span class="n">MM</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">HH</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">23</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">date_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"%s %02d:%02d"</span><span class="p">,</span><span class="w">
                          </span><span class="n">Q_date_p1</span><span class="p">,</span><span class="w">
                          </span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">HH</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="m">-24</span><span class="p">),</span><span class="w">
                          </span><span class="n">monster_frame</span><span class="o">$</span><span class="n">MM</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
      </span><span class="n">plotName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"tmpFig/%s_%02d:%02d.png"</span><span class="p">,</span><span class="w">
                         </span><span class="n">Q_date_p1</span><span class="p">,</span><span class="w">
                         </span><span class="n">monster_frame</span><span class="o">$</span><span class="n">HH</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w">
                         </span><span class="n">monster_frame</span><span class="o">$</span><span class="n">MM</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="c1"># Just to know where we are currently as it takes a while</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">date_time</span><span class="p">)</span><span class="w">
    </span><span class="c1"># Set up the plot</span><span class="w">
    </span><span class="n">png</span><span class="p">(</span><span class="n">plotName</span><span class="p">)</span><span class="w">
    </span><span class="n">plot</span><span class="p">(</span><span class="n">Winnipeg_map</span><span class="p">)</span><span class="w">
    </span><span class="n">title</span><span class="p">(</span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"%s"</span><span class="p">,</span><span class="n">date_time</span><span class="p">))</span><span class="w">
    </span><span class="c1"># Update current time/date</span><span class="w">
    </span><span class="n">curr_MM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">monster_frame</span><span class="o">$</span><span class="n">MM</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">points</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]))),</span><span class="w">
         </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">monster_frame</span><span class="o">$</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]))),</span><span class="w">
         </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">dev.off</span><span class="p">()</span></code></pre></figure> <p>Last piece: make an external call to <code class="language-plaintext highlighter-rouge">convert</code> (from <code class="language-plaintext highlighter-rouge">ImageMagick</code>) to create a gif file with all the individual, minute by minute plots.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">my_command</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'convert tmpFig/*.png -delay 3 -loop 0 Winnipeg_buses.gif'</span><span class="w">
</span><span class="n">system</span><span class="p">(</span><span class="n">my_command</span><span class="p">)</span></code></pre></figure> <p>It is not unlikely that you will get an error when executing this last command. This is due to the default policy of ImageMagick in terms of memory allocation. In this case, under Linux, you need to edit <code class="language-plaintext highlighter-rouge">/etc/ImageMagick-6/policy.xml</code>. Here is what the relevant lines read on my machine:</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;policymap&gt;</span>
  <span class="c">&lt;!-- &lt;policy domain="resource" name="temporary-path" value="/tmp"/&gt; --&gt;</span>
  <span class="nt">&lt;policy</span> <span class="na">domain=</span><span class="s">"resource"</span> <span class="na">name=</span><span class="s">"memory"</span> <span class="na">value=</span><span class="s">"2GiB"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;policy</span> <span class="na">domain=</span><span class="s">"resource"</span> <span class="na">name=</span><span class="s">"disk"</span> <span class="na">value=</span><span class="s">"2GiB"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/policymap&gt;</span></code></pre></figure> <p>The result is not the movement of buses themselves, but the activity of bus stops along the route.</p> <p><img src="https://server.math.umanitoba.ca/~jarino/images/Winnipeg_buses.gif" alt="Buses or ants?" title="Buses moving around"></p> <p>The problem here is file size (so much so that I could not post it on github). Also, the conversion itself can be quite time consuming. The next method addresses some of these issues.</p> <h2 id="second-animation-method---using-animation">Second animation method - using animation</h2> <p>The <code class="language-plaintext highlighter-rouge">animation</code> library uses <code class="language-plaintext highlighter-rouge">ffmpeg</code>, so this should be installed on your machine. (As often, this is a trivial task under Linux, it might be a bit more of a headache under Windows.)</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Julien Arino. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: February 02, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-97QKRGST95"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-97QKRGST95");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>